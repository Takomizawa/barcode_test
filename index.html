<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QR Code Battler</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- UI枠組み・デザイン（絶対維持） --- */
        :root {
            --bg-color: #000000;
            --text-main: #ffffff;
            --text-sub: #aaaaaa;
            
            --p1-bg: #ffffff;
            --p1-fg: #000000;
            --p1-border: #000000;
            --p1-overlay: rgba(255, 255, 255, 0.3);
            
            --p2-bg: #000000;
            --p2-fg: #ffffff;
            --p2-border: #ffffff;
            --p2-overlay: rgba(0, 0, 0, 0.6);

            --mask-color: rgba(0, 0, 0, 0.6);
            --guide-color: #ffffff;
            --guide-active: #ffffff;
        }

        body.p1-turn {
            --bg-color: #ffffff;
            --text-main: #000000;
            --text-sub: #555555;
            --border-color: #000000;
            --mask-color: rgba(255, 255, 255, 0.6);
            --guide-color: #000000;
            --guide-active: #000000;
        }

        body.p2-turn {
            --bg-color: #000000;
            --text-main: #ffffff;
            --text-sub: #aaaaaa;
            --border-color: #ffffff;
            --mask-color: rgba(0, 0, 0, 0.85);
            --guide-color: #ffffff;
            --guide-active: #ffffff;
        }

        body {
            font-family: "SF Pro Text", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        #scanner-wrapper {
            position: relative;
            flex: 1;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #reader {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            filter: grayscale(100%) contrast(1.1);
        }
        
        #reader video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }
        #reader canvas, #reader div:not(:first-child) { display: none !important; }

        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .player-turn-bar {
            position: absolute;
            top: 40px; left: 0; width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }
        .turn-badge {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #fff;
            padding: 6px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: none;
            transition: all 0.3s;
        }
        .turn-badge.p1 { background: var(--p1-bg); color: var(--p1-fg); border-color: var(--p1-fg); }
        .turn-badge.p2 { background: var(--p2-bg); color: var(--p2-fg); border-color: var(--p2-border); }

        .info-bar {
            position: absolute;
            top: 85px; left: 0; width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: auto;
        }
        .status-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            padding: 8px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            opacity: 0.95; 
            box-shadow: none;
            gap: 12px;
            transition: all 0.2s;
            min-width: 220px;
            position: relative;
            overflow: hidden;
            color: var(--text-main);
        }
        .status-pill::before {
            content: ''; position: absolute; top:0; left:0; width: 6px; height: 100%;
            background: var(--text-main);
        }
        .status-pill:active { transform: scale(0.98); }
        
        #p-job { font-family: monospace; letter-spacing: 0.5px; }
        .divider { width: 1px; height: 12px; background: var(--text-main); opacity: 0.5; }

        .step-indicator {
            position: absolute;
            top: 140px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        .step-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        .step-dot.active {
            background: var(--text-main);
            transform: scale(1.3);
            box-shadow: none;
        }
        .step-dot.done {
            background: var(--text-sub);
            border-color: var(--text-sub);
        }
        .step-line {
            width: 20px; height: 2px;
            background: var(--border-color);
            opacity: 0.3;
        }
        .step-line.done { background: var(--text-main); opacity: 0.8; }

        .scan-hint-container {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            text-align: center;
            background: linear-gradient(to top, var(--bg-color) 20%, transparent 100%);
            padding-bottom: 40px;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
        }

        .scan-hint {
            color: var(--text-main);
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-shadow: none;
            margin-bottom: 20px;
            background: var(--bg-color);
            padding: 4px 12px;
            border-radius: 4px;
        }
        
        #skip-btn {
            display: none;
            background: var(--bg-color);
            border: 2px solid var(--text-main);
            color: var(--text-main);
            padding: 10px 30px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
        }
        #skip-btn:active {
            background: var(--text-main);
            color: var(--bg-color);
        }
        #skip-btn.visible { display: inline-block; }

        #svg-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 5;
        }
        .mask-path { fill: var(--mask-color); fill-rule: evenodd; transition: fill 0.3s; }
        .guide-corner {
            fill: none; stroke: var(--guide-color); stroke-width: 4;
            stroke-linecap: round; transition: stroke 0.3s;
            filter: none;
        }
        #svg-overlay.active .guide-corner { stroke: var(--guide-active); stroke-width: 6; }

        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: opacity 0.5s;
        }
        .title-logo {
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 0.9;
            text-align: center;
            letter-spacing: -2px;
            margin-bottom: 50px;
            color: #fff;
            border: 6px solid #fff;
            padding: 30px;
        }
        .tap-start {
            font-size: 1.2rem;
            font-weight: 700;
            color: #888;
            animation: blink 1.5s infinite;
            letter-spacing: 2px;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        #turn-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 60;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 0.3s;
        }
        #turn-screen.visible { display: flex; }
        .turn-player { 
            font-size: 4rem; font-weight: 900; line-height: 1; margin-bottom: 40px; 
            text-transform: uppercase; font-style: italic;
            color: var(--text-main);
            text-shadow: none;
        }

        #vs-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #111;
            z-index: 200;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            padding-bottom: 40px;
        }
        #vs-screen.visible { display: flex; }
        .vs-header { text-align: center; padding: 20px 0; font-size: 2.5rem; font-weight: 900; background: #000; border-bottom: 2px solid #fff; }
        .vs-container { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .player-card { border-radius: 16px; padding: 20px; border: 4px solid; position: relative; }
        
        .player-card.p1 { background: var(--p1-bg); border-color: var(--p1-border); color: var(--p1-fg); }
        .player-card.p2 { background: var(--p2-bg); border-color: var(--p2-border); color: var(--p2-fg); }

        .pc-label { position: absolute; top: -12px; left: 20px; padding: 2px 12px; font-weight: 800; font-size: 0.8rem; border-radius: 4px; border: 2px solid; }
        .pc-label.p1 { background: #000; color: #fff; border-color: #000; }
        .pc-label.p2 { background: #fff; color: #000; border-color: #fff; }

        .pc-info { text-align: center; margin-bottom: 15px; margin-top: 10px;}
        .pc-name { font-size: 1.2rem; font-weight: 800; font-family: monospace; text-align: center; margin-top: 10px; }
        .pc-job { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
        
        .pc-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; gap: 5px; background: rgba(128,128,128,0.2); border-radius: 8px; padding: 10px 0; margin: 15px 0; }
        .pc-equip-list { font-size: 0.8rem; }
        .pc-equip-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed; }
        .player-card.p1 .pc-equip-item { border-color: #000; }
        .player-card.p2 .pc-equip-item { border-color: #fff; }
        .pc-equip-item:last-child { border-bottom: none; }
        
        #battle-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: transparent; 
            z-index: 100; display: none; flex-direction: column; 
        }
        #battle-screen.visible { display: flex; }

        .battle-view { 
            flex: 1; padding: 20px; 
            display: flex; flex-direction: column; justify-content: space-between; 
            position: relative;
        }
        body.p1-turn .battle-view { background: var(--p1-overlay); }
        body.p2-turn .battle-view { background: var(--p2-overlay); }

        .battler-card { 
            border: 3px solid; border-radius: 16px; padding: 15px 20px; 
            box-shadow: none; opacity: 1;
        }
        .battler-card.p1 { background: var(--p1-bg); color: var(--p1-fg); border-color: var(--p1-fg); }
        .battler-card.p2 { background: var(--p2-bg); color: var(--p2-fg); border-color: var(--p2-border); text-align: right; }

        .b-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .p2 .b-header { flex-direction: row-reverse; }
        
        .b-name { font-size: 1.1rem; font-weight: 800; letter-spacing: -0.5px; }
        .b-job { font-size: 0.75rem; font-weight: 700; padding: 3px 8px; border-radius: 6px; border: 2px solid; }
        .p1 .b-job { border-color: #000; } .p2 .b-job { border-color: #fff; }
        
        .b-hp-bar-bg { width: 100%; height: 14px; border: 2px solid; border-radius: 6px; overflow: hidden; margin-bottom: 4px; }
        .p1 .b-hp-bar-bg { border-color: #000; background: #eee; }
        .p2 .b-hp-bar-bg { border-color: #fff; background: #333; }

        .b-hp-bar { height: 100%; width: 100%; transition: width 0.5s ease-out; }
        .p1-bar { background: #000; } .p2-bar { background: #fff; }

        .b-hp-text { font-size: 1.6rem; font-weight: 900; font-family: "SF Pro Display", sans-serif; letter-spacing: -1px; }

        .battle-log-area { 
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); 
            width: 100%; text-align: center; pointer-events: none; z-index: 20; 
        }
        .log-text { 
            font-size: 1.1rem; font-weight: 800; 
            background: #fff; color: #000; padding: 10px 30px; border-radius: 30px; 
            display: inline-block; opacity: 0; transition: opacity 0.2s; border: 3px solid #000; box-shadow: none; 
        }
        .log-text.show { opacity: 1; }
        .dmg-popup { 
            font-size: 4.5rem; font-weight: 900; color: #fff; 
            text-shadow: none; -webkit-text-stroke: 3px #000; 
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); 
            opacity: 0; font-family: sans-serif; font-style: italic;
        }
        @keyframes popDamage { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 40% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -80%) scale(1.0); opacity: 0; } }

        .command-area { 
            background: #000; padding: 20px; 
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
            border-top: 4px solid #fff; 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
        }
        .cmd-btn { background: #111; border: 2px solid #444; border-radius: 12px; padding: 18px; color: #888; font-size: 0.9rem; font-weight: 800; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; cursor: not-allowed; box-shadow: none; }
        .cmd-sub { font-size: 0.65rem; font-weight: 600; margin-top: 4px; opacity: 0.7; }
        
        .cmd-btn.p1-active { background: #fff; color: #000; border-color: #fff; cursor: pointer; }
        .cmd-btn.p2-active { background: #000; color: #fff; border-color: #fff; cursor: pointer; }
        .cmd-btn:active { transform: scale(0.96); }

        #skill-modal { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; background: var(--bg-color); border-top: 4px solid var(--border-color); z-index: 300; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; box-shadow: none; }
        #skill-modal.visible { transform: translateY(0); }
        .skill-header { padding: 15px; text-align: center; font-weight: 900; color: var(--bg-color); background: var(--text-main); }
        .skill-list { flex: 1; overflow-y: auto; padding: 10px; }
        .skill-item { padding: 18px; border-radius: 8px; margin-bottom: 8px; background: var(--bg-color); border: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; color: var(--text-main); font-weight: 700; }
        .skill-item:active { background: var(--text-sub); }
        .skill-item.used { opacity: 0.4; cursor: not-allowed; text-decoration: line-through; border-style: dashed; }

        #result-modal { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 500; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #result-modal .modal-content { border: 6px solid; padding: 50px 20px; width: 90%; text-align: center; box-shadow: none; }

        .modal { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 150; display: none; flex-direction: column; justify-content: flex-end; }
        .modal.visible { display: flex; }
        .modal-content { background: var(--bg-color); border-top: 4px solid var(--border-color); padding: 30px 24px 60px; text-align: center; animation: slideUp 0.3s; box-shadow: none; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .btn { width: 100%; padding: 18px; border-radius: 10px; border: 2px solid var(--border-color); font-size: 1.1rem; font-weight: 900; background: var(--text-main); color: var(--bg-color); margin-top: 15px; cursor: pointer; transition: transform 0.1s; letter-spacing: 1px; }
        .btn-equip { background: var(--bg-color); color: var(--text-main); border: 2px solid var(--border-color); }
        .btn-danger { background: #000; color: #fff; border: 6px double #fff; font-size: 1.2rem; }

        #toast { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 16px 32px; font-weight: 900; opacity: 0; pointer-events: none; z-index: 400; transition: opacity 0.2s; border: 4px solid #000; box-shadow: none; font-size: 1.1rem; }
        #toast.show { opacity: 1; }
        .shaking { animation: shake 0.4s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    </style>
</head>
<body>

    <!-- Start Screen -->
    <div id="start-screen" onclick="initApp()">
        <div class="title-logo">QR CODE<br>BATTLER</div>
        <div class="tap-start">TAP TO START</div>
    </div>

    <!-- Main Game Wrapper -->
    <div id="scanner-wrapper">
        <div id="reader"></div>
        
        <div id="turn-screen">
            <div class="turn-label">CURRENT TURN</div>
            <div class="turn-player" id="turn-player-text">PLAYER 1</div>
            <button class="btn" style="width:200px;" onclick="startTurnAction()">準備完了</button>
        </div>

        <div id="vs-screen">
            <div class="vs-header">VS</div>
            <div class="vs-container">
                <div class="player-card p1" id="vs-p1-card">
                    <div class="pc-label p1">PLAYER 1</div>
                    <div class="pc-info"><div class="pc-name" id="vs-p1-name">--</div><div class="pc-job" id="vs-p1-job">--</div></div>
                    <div class="pc-stats">
                        <div><span class="stat-label">HP</span><span class="stat-val" id="vs-p1-hp">0</span></div>
                        <div><span class="stat-label">ST</span><span class="stat-val" id="vs-p1-st">0</span></div>
                        <div><span class="stat-label">DF</span><span class="stat-val" id="vs-p1-df">0</span></div>
                    </div>
                </div>
                <div class="player-card p2" id="vs-p2-card">
                    <div class="pc-label p2">PLAYER 2</div>
                    <div class="pc-info"><div class="pc-name" id="vs-p2-name">--</div><div class="pc-job" id="vs-p2-job">--</div></div>
                    <div class="pc-stats">
                        <div><span class="stat-label">HP</span><span class="stat-val" id="vs-p2-hp">0</span></div>
                        <div><span class="stat-label">ST</span><span class="stat-val" id="vs-p2-st">0</span></div>
                        <div><span class="stat-label">DF</span><span class="stat-val" id="vs-p2-df">0</span></div>
                    </div>
                </div>
            </div>
            <div style="padding:20px;"><button class="btn btn-danger" onclick="startCombatMode()">対戦開始</button></div>
        </div>

        <svg id="svg-overlay"><path id="mask-path" class="mask-path" d=""/><path id="guide-path" class="guide-corner" d=""/></svg>
        
        <div id="ui-layer">
            <div class="player-turn-bar"><div class="turn-badge" id="turn-badge">PLAYER 1 TURN</div></div>
            <div class="info-bar">
                <div class="status-pill" id="player-status" onclick="showCharModal()">
                    <span id="p-job">No Data</span><div class="divider"></div><span id="p-name">Scan QR</span>
                </div>
            </div>
            <div class="step-indicator">
                <div class="step-dot active" id="dot-1"></div><div class="step-line" id="line-1"></div>
                <div class="step-dot" id="dot-2"></div>
            </div>
            
            <div class="scan-hint-container">
                <div class="scan-hint" id="scan-hint-text">まずはキャラクターQRをスキャン！</div>
                <button id="skip-btn" onclick="skipItemScan()">装備なしで完了(SKIP)</button>
            </div>
        </div>
        <div id="toast">Message</div>
    </div>

    <!-- Battle Screen -->
    <div id="battle-screen">
        <div class="battle-view">
            <div class="battler-card p2" id="box-p2">
                <div class="b-header"><span class="b-name">PLAYER 2</span><span class="b-job" id="b-p2-job">WIZARD</span></div>
                <div class="b-hp-container">
                    <div class="b-hp-bar-bg"><div class="b-hp-bar p2-bar" id="b-p2-fill" style="width:100%"></div></div>
                    <div class="b-hp-text" id="b-p2-hp">0</div>
                </div>
            </div>
            <div class="battle-log-area"><div class="log-text" id="battle-log">READY...</div><div class="dmg-popup" id="dmg-popup">0</div></div>
            <div class="battler-card p1" id="box-p1">
                <div class="b-header"><span class="b-name">PLAYER 1</span><span class="b-job" id="b-p1-job">WARRIOR</span></div>
                <div class="b-hp-container">
                    <div class="b-hp-bar-bg"><div class="b-hp-bar p1-bar" id="b-p1-fill" style="width:100%"></div></div>
                    <div class="b-hp-text" id="b-p1-hp">0</div>
                </div>
            </div>
        </div>
        <div class="command-area">
            <button id="cmd-p1-battle" class="cmd-btn" onclick="execCmd('p1', 'battle')"><span>P1 BATTLE</span><span class="cmd-sub">物理技選択</span></button>
            <button id="cmd-p1-power" class="cmd-btn" onclick="execCmd('p1', 'power')"><span>P1 POWER</span><span class="cmd-sub">特殊技選択</span></button>
            <button id="cmd-p2-battle" class="cmd-btn" onclick="execCmd('p2', 'battle')"><span>P2 BATTLE</span><span class="cmd-sub">物理技選択</span></button>
            <button id="cmd-p2-power" class="cmd-btn" onclick="execCmd('p2', 'power')"><span>P2 POWER</span><span class="cmd-sub">特殊技選択</span></button>
        </div>
    </div>

    <!-- Modals -->
    <div id="skill-modal">
        <div class="skill-header">技を選択</div>
        <div class="skill-list" id="skill-list-container"></div>
        <div style="padding:10px;"><button class="btn btn-equip" onclick="closeSkillMenu()">キャンセル</button></div>
    </div>

    <div id="char-modal" class="modal">
        <div class="modal-content">
            <div class="c-title">読み取ったキャラクター</div>
            <div class="char-name" id="cm-name">--</div>
            <div class="char-job" id="cm-job" style="margin-bottom:20px;">--</div>
            <div style="font-family:monospace; font-weight:bold; background:var(--text-main); color:var(--bg-color); padding:15px; border:1px solid var(--border-color);">
                HP <span id="cm-hp">0</span> / ST <span id="cm-st">0</span> / DF <span id="cm-df">0</span>
            </div>
            <button class="btn" onclick="closeModal()">確認</button>
        </div>
    </div>

    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="c-title">アイテム発見！</div>
            <div class="item-card" id="new-item-card" style="border:none; padding:10px;">
                <div id="item-stars" style="letter-spacing:3px;">★</div>
                <div id="item-type" style="font-size:0.8rem; margin:5px 0;">WEAPON</div>
                <div id="item-name" style="font-size:1.5rem; font-weight:900;">--</div>
                <div style="margin-top:15px; font-family:monospace;">
                    ST<span id="item-st">+0</span> DF<span id="item-df">+0</span> HP<span id="item-hp">+0</span>
                </div>
            </div>
            <button class="btn" onclick="equipItem()">装備</button>
            <button class="btn btn-equip" style="margin-top:10px;" onclick="discardItem()">破棄</button>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="modal-content">
            <div class="c-title">対戦結果</div>
            <div id="winner-text" style="font-size:3rem; font-weight:900; margin:20px 0;">勝者決定！</div>
            <div id="winner-pname" style="font-size:1.8rem; font-weight:900;">PLAYER 1</div>
            <div style="margin-top:20px; font-weight:800;">残りHP: <span id="winner-hp-val" style="font-family:monospace;">0</span></div>
            <button class="btn btn-danger" onclick="location.reload()">再戦</button>
        </div>
    </div>

    <script>
        // --- M2281 CORE ---
        const M2281_PRIME = 2n ** 2281n - 1n;
        const getSeed = (s) => { let h = 0n; const MULT = 127n; for (let i=0; i<s.length; i++) h = (h * MULT + BigInt(s.charCodeAt(i))) % M2281_PRIME; return h; };
        const createRNG = (s) => { let seed = s; return () => { seed = (seed * 48271n) % M2281_PRIME; return Number(seed % 100000000n) / 100000000; }; };

        // 技リスト (物理: 戦士系, 特殊: 魔法使い系)
        const SKILLS_PHYSICAL = [
            { name: "一刀両断", rate: 1.4, crit: 0.10 }, { name: "兜割り", rate: 1.2, crit: 0.20 },
            { name: "疾風突き", rate: 1.0, crit: 0.30 }, { name: "回し蹴り", rate: 1.1, crit: 0.15 },
            { name: "正拳突き", rate: 1.3, crit: 0.10 }, { name: "大車輪", rate: 1.5, crit: 0.05 },
            { name: "無双乱舞", rate: 1.8, crit: 0.01 }, { name: "タックル", rate: 1.0, crit: 0.05 },
            { name: "スマッシュ", rate: 1.2, crit: 0.10 }, { name: "十文字斬り", rate: 1.4, crit: 0.10 },
            { name: "シールドバッシュ", rate: 0.9, crit: 0.05 }, { name: "捨て身の突撃", rate: 1.7, crit: 0.05 },
            { name: "カウンター", rate: 1.1, crit: 0.25 }, { name: "アースクエイク", rate: 1.6, crit: 0.05 },
            { name: "鬼神の如く", rate: 2.0, crit: 0.01 }
        ];

        const SKILLS_MAGICAL = [
            { name: "ファイア", rate: 1.2, crit: 0.10 }, { name: "ブリザード", rate: 1.2, crit: 0.10 },
            { name: "サンダー", rate: 1.3, crit: 0.15 }, { name: "エアロ", rate: 1.1, crit: 0.05 },
            { name: "ストーン", rate: 1.4, crit: 0.05 }, { name: "バイオ", rate: 1.0, crit: 0.05 },
            { name: "グラビデ", rate: 1.5, crit: 0.05 }, { name: "フレア", rate: 1.7, crit: 0.10 },
            { name: "ホーリー", rate: 1.8, crit: 0.10 }, { name: "メテオ", rate: 2.1, crit: 0.05 },
            { name: "アルテマ", rate: 2.5, crit: 0.01 }, { name: "ジハード", rate: 2.3, crit: 0.05 },
            { name: "アポカリプス", rate: 2.4, crit: 0.01 }, { name: "デス", rate: 0.5, crit: 0.50 },
            { name: "ビッグバン", rate: 2.2, crit: 0.05 }
        ];

        // Global functions
        function getCurrentPlayer() { return turn === 1 ? p1Data : p2Data; }
        function getQRType(str) { const seed = getSeed(str); return (seed % 2n === 0n) ? 'char' : 'item'; }

        function generateChar(code) {
            const seed = getSeed(code);
            const r = createRNG(seed);
            
            const isWarrior = r() > 0.4;
            const job = isWarrior ? "戦士" : "魔法使い";
            const tribe = ["メカ", "鳥族", "獣族", "人間", "海族"][Math.floor(r()*5)];

            // ステータスバランス (HP:ST = 6:1)
            let st = 4000 + Math.floor(r() * 60) * 100; // 4,000 ~ 10,000
            let hp = st * 6; // 基本6倍
            
            let df = Math.floor(st * 0.4) + Math.floor(r() * 20) * 100;
            let dx = Math.floor(r() * 100);

            // Job補正
            if (isWarrior) {
                st = Math.floor(st * 1.1);
                hp = Math.floor(hp * 1.1); 
                df = Math.floor(df * 1.1);
            } else {
                dx += 20; // 魔法使いは早い
            }

            // 技生成: ランダムに6〜10個
            const numSkills = 6 + Math.floor(r() * 5); 
            const skills = [];
            
            const pickUnique = (arr, count) => {
                const shuffled = [...arr].sort(() => 0.5 - r());
                return shuffled.slice(0, count);
            };

            // 戦士は物理重視、魔法使いは魔法重視
            const bCount = isWarrior ? Math.ceil(numSkills * 0.7) : Math.floor(numSkills * 0.3);
            const pCount = numSkills - bCount;
            
            const bSkills = pickUnique(SKILLS_PHYSICAL, bCount);
            const pSkills = pickUnique(SKILLS_MAGICAL, pCount);
            
            bSkills.forEach(s => {
                let mult = s.rate * (0.9 + r() * 0.2); // 個体差
                skills.push({ name: s.name, mult: parseFloat(mult.toFixed(2)), critRate: s.crit, type: 'battle', used: false });
            });
            pSkills.forEach(s => {
                let mult = s.rate * (0.9 + r() * 0.2);
                skills.push({ name: s.name, mult: parseFloat(mult.toFixed(2)), critRate: s.crit, type: 'power', used: false });
            });

            return { 
                id: code, tribe, job, 
                baseHp: hp, baseSt: st, baseDf: df, dx,
                hp, maxHp: hp, st, df, 
                items: [], skills, isWarrior 
            };
        }

        function generateItem(code) {
            const r = createRNG(getSeed(code));
            const roll = r();
            let type = roll < 0.4 ? "weapon" : (roll < 0.8 ? "armor" : "accessory");
            let rarity = roll < 0.6 ? 1 : (roll < 0.85 ? 2 : (roll < 0.95 ? 3 : (roll < 0.99 ? 4 : 5)));
            
            const pList = ["錆びた", "鉄の", "名工の", "魔光の", "神々の"];
            const bList = { weapon: ["剣", "斧", "槍"], armor: ["盾", "鎧", "兜"], accessory: ["指輪", "お守り", "勲章"] };
            const typeLabel = { weapon: "武器", armor: "防具", accessory: "装飾品" };

            const name = pList[rarity-1] + bList[type][Math.floor(r()*3)];
            
            let s=0, d=0, h=0;
            const baseVal = 500 * rarity;
            
            if(type==="weapon") s = Math.floor(baseVal * (1 + r()));
            else if(type==="armor") d = Math.floor(baseVal * (1 + r()));
            else h = Math.floor(baseVal * 6 * (1 + r())); // アイテムもHP重視
            
            return { name, type: typeLabel[type], rarity, st:s, df:d, hp:h };
        }

        // --- APP STATE ---
        let turn = 1, p1Data = null, p2Data = null, isScanning = false, pendingItem = null;
        let bTurn = 1, bActive = false;
        const html5QrCode = new Html5Qrcode("reader");

        const ui = {
            start: document.getElementById('start-screen'),
            turnScreen: document.getElementById('turn-screen'),
            turnPlayerText: document.getElementById('turn-player-text'),
            vsScreen: document.getElementById('vs-screen'),
            overlay: document.getElementById('svg-overlay'),
            mask: document.getElementById('mask-path'),
            guide: document.getElementById('guide-path'),
            turnBadge: document.getElementById('turn-badge'),
            pJob: document.getElementById('p-job'),
            pName: document.getElementById('p-name'),
            hint: document.getElementById('scan-hint-text'),
            toast: document.getElementById('toast'),
            skipBtn: document.getElementById('skip-btn'),
            dot1: document.getElementById('dot-1'), dot2: document.getElementById('dot-2'),
            charModal: document.getElementById('char-modal'), cmName: document.getElementById('cm-name'), cmJob: document.getElementById('cm-job'),
            cmHp: document.getElementById('cm-hp'), cmSt: document.getElementById('cm-st'), cmDf: document.getElementById('cm-df'),
            itemModal: document.getElementById('item-modal'), itemCard: document.getElementById('new-item-card'),
            battleScreen: document.getElementById('battle-screen'), bP1Hp: document.getElementById('b-p1-hp'), bP2Hp: document.getElementById('b-p2-hp'),
            bP1Bar: document.getElementById('b-p1-fill'), bP2Bar: document.getElementById('b-p2-fill'), bP1Job: document.getElementById('b-p1-job'), bP2Job: document.getElementById('b-p2-job'),
            logMsg: document.getElementById('battle-log'), dmgPopup: document.getElementById('dmg-popup'),
            btns: { p1b: document.getElementById('cmd-p1-battle'), p1p: document.getElementById('cmd-p1-power'), p2b: document.getElementById('cmd-p2-battle'), p2p: document.getElementById('cmd-p2-power') },
            skillModal: document.getElementById('skill-modal'), skillList: document.getElementById('skill-list-container'),
            resultModal: document.getElementById('result-modal')
        };

        function initApp() { ui.start.style.display = 'none'; turn = 1; showTurnScreen(); }
        function showTurnScreen() {
            ui.turnPlayerText.innerText = `PLAYER ${turn}`;
            ui.turnPlayerText.className = `turn-player p${turn}-text`;
            document.body.className = `p${turn}-turn`; 
            document.getElementById('turn-screen').style.backgroundColor = turn === 1 ? '#fff' : '#000';
            ui.turnPlayerText.style.color = turn === 1 ? '#000' : '#fff';
            ui.turnScreen.classList.add('visible');
            ui.overlay.classList.remove('active', 'char-mode', 'complete');
        }
        function startTurnAction() {
            ui.turnScreen.classList.remove('visible');
            updatePrepUI(); 
            const w = window.innerWidth;
            const config = { fps: 30, qrbox: { width: Math.floor(w*0.8), height: Math.floor(w*0.8) }, aspectRatio: 1.0, formatsToSupport: [ 0 ] };
            html5QrCode.start({ facingMode: "environment" }, config, onScan).then(() => { isScanning = true; resizeOverlay(); });
        }
        
        function onScan(text, result) {
            if (!isScanning) return;
            if (!result.result.format.formatName.includes("QR")) return;
            const player = getCurrentPlayer();
            const qrType = getQRType(text);
            if (!player) {
                if (qrType !== 'char') { showToast("⚠ アイテム用QRです。キャラ用を探してください"); return; }
                foundChar(text);
            } else {
                if (qrType !== 'item') { showToast("⚠ キャラ用QRです。アイテム用を探してください"); return; }
                foundItem(text);
            }
        }
        function foundChar(c) { 
            isScanning = false; const data = generateChar(c); pendingItem = { type:'char', data }; 
            ui.cmName.innerText = "CODE: " + c.substring(0,8); ui.cmJob.innerText = data.tribe + " / " + data.job; 
            ui.cmHp.innerText = data.hp; ui.cmSt.innerText = data.st; ui.cmDf.innerText = data.df; 
            ui.charModal.classList.add('visible'); 
        }
        function foundItem(c) { 
            isScanning = false; const data = generateItem(c); pendingItem = { type:'item', data }; 
            document.getElementById('item-stars').innerText = "★".repeat(data.rarity); 
            document.getElementById('item-name').innerText = data.name; 
            document.getElementById('item-st').innerText = "+"+data.st; 
            document.getElementById('item-df').innerText = "+"+data.df; 
            document.getElementById('item-hp').innerText = "+"+data.hp; 
            ui.itemModal.classList.add('visible'); 
        }
        function equipItem() { 
            const player = getCurrentPlayer(); if (!player || !pendingItem || !pendingItem.data) return;
            player.items.push(pendingItem.data); recalcStats(player); updatePlayerUI(); 
            nextPhase(); ui.itemModal.classList.remove('visible');
        }
        function skipItemScan() {
            if (!isScanning) return;
            const player = getCurrentPlayer(); if (!player) return;
            isScanning = false; recalcStats(player); updatePlayerUI(); nextPhase();
        }
        function nextPhase() {
            html5QrCode.stop().then(() => { if (turn === 1) { turn = 2; setTimeout(showTurnScreen, 500); } else { setTimeout(showVsScreen, 500); } });
        }
        function closeModal() { 
            ui.charModal.classList.remove('visible'); 
            if(pendingItem && pendingItem.type==='char') { if(turn===1) p1Data=pendingItem.data; else p2Data=pendingItem.data; } 
            isScanning = true; updatePrepUI(); updatePlayerUI(); 
        }
        function discardItem() { ui.itemModal.classList.remove('visible'); pendingItem = null; isScanning = true; updatePrepUI(); }
        function recalcStats(p) { p.hp = p.baseHp; p.st = p.baseSt; p.df = p.baseDf; p.items.forEach(i => { p.hp += i.hp; p.st += i.st; p.df += i.df; }); p.maxHp = p.hp; }
        function updatePlayerUI() { const p = getCurrentPlayer(); if (!p) return; ui.pJob.innerText = p.job; ui.pName.innerText = "CODE: " + p.id.substring(0, 6); }
        function showCharModal() { const p = getCurrentPlayer(); if(!p) return; ui.cmName.innerText = "CODE: " + p.id.substring(0,8); ui.cmJob.innerText = p.tribe + " / " + p.job; ui.cmHp.innerText = p.hp; ui.cmSt.innerText = p.st; ui.cmDf.innerText = p.df; ui.charModal.classList.add('visible'); isScanning = false; }
        
        function showVsScreen() {
            document.getElementById('vs-p1-name').innerText = "CODE: " + p1Data.id.substring(0,6); document.getElementById('vs-p1-job').innerText = p1Data.tribe + " " + p1Data.job; document.getElementById('vs-p1-hp').innerText = p1Data.hp; document.getElementById('vs-p1-st').innerText = p1Data.st; document.getElementById('vs-p1-df').innerText = p1Data.df;
            document.getElementById('vs-p1-equip').innerHTML = p1Data.items.map(i => `<div class="pc-equip-item"><span>${i.name}</span><span>★${i.rarity}</span></div>`).join('');
            document.getElementById('vs-p2-name').innerText = "CODE: " + p2Data.id.substring(0,6); document.getElementById('vs-p2-job').innerText = p2Data.tribe + " " + p2Data.job; document.getElementById('vs-p2-hp').innerText = p2Data.hp; document.getElementById('vs-p2-st').innerText = p2Data.st; document.getElementById('vs-p2-df').innerText = p2Data.df;
            document.getElementById('vs-p2-equip').innerHTML = p2Data.items.map(i => `<div class="pc-equip-item"><span>${i.name}</span><span>★${i.rarity}</span></div>`).join('');
            ui.vsScreen.classList.add('visible');
        }

        function startCombatMode() { 
            ui.vsScreen.classList.remove('visible'); ui.battleScreen.classList.add('visible'); 
            p1Data.curHp = p1Data.hp; p2Data.curHp = p2Data.hp; 
            bTurn = (p1Data.dx >= p2Data.dx) ? 1 : 2; 
            updateBattleUI(); log(`BATTLE START! P${bTurn}の先制`); updateCommandUI(); 
        }

        function updateBattleUI() { 
            ui.bP1Hp.innerText = Math.floor(p1Data.curHp); ui.bP2Hp.innerText = Math.floor(p2Data.curHp); 
            ui.bP1Bar.style.width = (p1Data.curHp/p1Data.maxHp*100) + "%"; ui.bP2Bar.style.width = (p2Data.curHp/p2Data.maxHp*100) + "%"; 
            ui.bP1Job.innerText = p1Data.job; ui.bP2Job.innerText = p2Data.job;
        }

        function updateCommandUI() { 
            ['cmd-p1-battle','cmd-p1-power','cmd-p2-battle','cmd-p2-power'].forEach(id => document.getElementById(id).className='cmd-btn'); 
            if (bActive) return; 
            if (bTurn === 1) { document.getElementById('cmd-p1-battle').classList.add("p1-active"); document.getElementById('cmd-p1-power').classList.add("p1-active"); } 
            else { document.getElementById('cmd-p2-battle').classList.add("p2-active"); document.getElementById('cmd-p2-power').classList.add("p2-active"); } 
        }

        function execCmd(p, type) { if ((p==='p1' && bTurn!==1) || (p==='p2' && bTurn!==2) || bActive) return; openSkillMenu(p, type); }
        function openSkillMenu(p, type) { 
            const data = bTurn === 1 ? p1Data : p2Data; 
            ui.skillList.innerHTML = ""; 
            const targets = data.skills.filter(s => s.type === type);
            targets.forEach(s => { 
                const div = document.createElement('div'); 
                div.className = `skill-item ${s.used ? 'used' : ''}`; 
                div.innerHTML = `<span>${s.name}</span><span class="skill-pow">x${s.mult}</span>`; 
                if(!s.used) div.onclick = () => { closeSkillMenu(); executeAction(s); }; 
                ui.skillList.appendChild(div); 
            }); 
            ui.skillModal.classList.add('visible'); 
        }
        function closeSkillMenu() { ui.skillModal.classList.remove('visible'); }

        function executeAction(skill) {
            if(bActive || skill.used) return; bActive = true; updateCommandUI();
            skill.used = true;
            const atk = bTurn === 1 ? p1Data : p2Data; const def = bTurn === 1 ? p2Data : p1Data;
            const defBox = bTurn === 1 ? document.getElementById('box-p2') : document.getElementById('box-p1');
            log(`${skill.name} !!`);
            setTimeout(() => {
                let dmg = (atk.st * skill.mult) - (def.df * 0.4);
                const adv = { 'メカ': '鳥族', '鳥族': '獣族', '獣族': '人間', '人間': '海族', '海族': 'メカ' };
                if (adv[atk.tribe] === def.tribe) dmg *= 1.2;
                if (dmg < atk.st * 0.1) dmg = atk.st * 0.1;
                dmg = Math.floor(dmg * (0.9 + Math.random() * 0.2));
                let isCrit = Math.random() < skill.critRate; // 技固有クリティカル
                if (isCrit) { dmg = Math.floor(dmg * 1.5); }
                def.curHp -= dmg; if (def.curHp < 0) def.curHp = 0;
                defBox.classList.add('shaking'); setTimeout(() => defBox.classList.remove('shaking'), 400);
                showDmg(isCrit ? "CRIT!" : dmg, "#fff"); updateBattleUI();
                if (def.curHp <= 0) { 
                    log(`PLAYER ${bTurn} WIN!!`); setTimeout(() => showResult(bTurn), 1500);
                } else {
                    const allUsed = atk.skills.every(s => s.used);
                    if (allUsed) {
                        setTimeout(() => { log("技パワー全回復！"); atk.skills.forEach(s => s.used = false); setTimeout(() => { bTurn = bTurn === 1 ? 2 : 1; bActive = false; log(`PLAYER ${bTurn} TURN`); updateCommandUI(); }, 1000); }, 1000);
                    } else {
                        setTimeout(() => { bTurn = bTurn === 1 ? 2 : 1; bActive = false; log(`PLAYER ${bTurn} TURN`); updateCommandUI(); }, 1200);
                    }
                }
            }, 600);
        }

        function showResult(winner) {
            const winnerData = winner === 1 ? p1Data : p2Data;
            const resultModal = document.getElementById('result-modal');
            const content = resultModal.querySelector('.modal-content');
            if (winner === 1) { content.style.backgroundColor = '#ffffff'; content.style.color = '#000000'; content.style.borderColor = '#000000'; }
            else { content.style.backgroundColor = '#000000'; content.style.color = '#ffffff'; content.style.borderColor = '#ffffff'; }
            document.getElementById('winner-pname').innerText = `PLAYER ${winner}`;
            document.getElementById('winner-hp-val').innerText = Math.floor(winnerData.curHp);
            ui.resultModal.classList.add('visible');
        }

        function log(m) { ui.logMsg.innerText = m; ui.logMsg.classList.remove('show'); void ui.logMsg.offsetWidth; ui.logMsg.classList.add('show'); }
        function showDmg(v, c) { ui.dmgPopup.innerText = v; ui.dmgPopup.style.color = c; ui.dmgPopup.style.animation = 'none'; void ui.dmgPopup.offsetWidth; ui.dmgPopup.style.animation = 'popDamage 0.6s forwards'; }
        function showToast(m) { ui.toast.innerText = m; ui.toast.classList.add('show'); setTimeout(() => ui.toast.classList.remove('show'), 2000); }
        function updatePrepUI() { 
            const p = getCurrentPlayer(); const s = p ? p.items.length + 1 : 0; ui.turnBadge.innerText = `PLAYER ${turn} TURN`; 
            ui.dot1.className = s >= 1 ? 'step-dot done' : (s === 0 ? 'step-dot active' : 'step-dot'); 
            ui.dot2.className = s >= 2 ? 'step-dot done' : (s === 1 ? 'step-dot active' : 'step-dot'); 
            if (s === 0) { ui.hint.innerText = "まずはキャラクターQRをスキャン！"; ui.skipBtn.classList.remove('visible'); }
            else { ui.hint.innerText = "次はアイテムQRを探索！"; ui.skipBtn.classList.add('visible'); }
        }
        function resizeOverlay() {
            const w = window.innerWidth, h = window.innerHeight, bw = Math.min(800, w * 0.85), bh = Math.min(bw, h * 0.6), x = (w - bw) / 2, y = (h - bh) / 2;
            const mask = document.getElementById('mask-path'); const guide = document.getElementById('guide-path');
            if (!mask || !guide) return;
            mask.setAttribute('d', `M 0 0 H ${w} V ${h} H 0 Z M ${x+24} ${y} H ${x+bw-24} Q ${x+bw} ${y} ${x+bw} ${y+24} V ${y+bh-24} Q ${x+bw} ${y+bh} ${x+bw-24} ${y+bh} H ${x+24} Q ${x} ${y+bh} ${x} ${y+bh-24} V ${y+24} Q ${x} ${y} ${x+24} ${y} Z`);
            guide.setAttribute('d', `M ${x} ${y+40} V ${y+24} Q ${x} ${y} ${x+24} ${y} H ${x+40} M ${x+bw-40} ${y} H ${x+bw-24} Q ${x+bw} ${y} ${x+bw} ${y+24} V ${y+40} M ${x+bw} ${y+bh-40} V ${y+bh-24} Q ${x+bw} ${y+bh} ${x+bw-24} ${y+bh} H ${x+bw-40} M ${x+40} ${y+bh} H ${x+24} Q ${x} ${y+bh} ${x} ${y+bh-24} V ${y+bh-40}`);
        }
        window.addEventListener('resize', resizeOverlay);
    </script>
</body>
</html>
