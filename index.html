<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Barcode Battler Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --primary-color: #007aff;
            --p1-color: #0a84ff;
            --p2-color: #ff453a;
            --mask-color: rgba(0, 0, 0, 0.6);
            --guide-color: #ffffff;
            --guide-active: #ffd60a;
            
            /* UI Colors */
            --stat-bg: #1c1c1e;
            --hp-color: #ff453a;
            --st-color: #ffd60a;
            --df-color: #32d74b;
            
            /* Rarity Colors */
            --rarity-1: #8e8e93;
            --rarity-2: #32d74b;
            --rarity-3: #0a84ff;
            --rarity-4: #bf5af2;
            --rarity-5: #ffd60a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- カメラエリア --- */
        #scanner-wrapper {
            position: relative;
            flex: 1;
            width: 100%;
            height: 100%;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #reader {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
        }
        
        #reader video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }
        #reader canvas, #reader div:not(:first-child) { display: none !important; }

        /* --- UI Overlay --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        /* プレイヤーインジケーター */
        .player-turn-bar {
            position: absolute;
            top: 50px; left: 0; width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }
        .turn-badge {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
            letter-spacing: 1px;
        }
        .turn-badge.p1 { border-color: var(--p1-color); color: var(--p1-color); box-shadow: 0 0 10px rgba(10, 132, 255, 0.3); }
        .turn-badge.p2 { border-color: var(--p2-color); color: var(--p2-color); box-shadow: 0 0 10px rgba(255, 69, 58, 0.3); }

        /* 情報バー (HUD風) */
        .info-bar {
            position: absolute;
            top: 90px; left: 0; width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: auto;
        }
        .status-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(10, 10, 15, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 24px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            gap: 12px;
            transition: all 0.2s;
            min-width: 200px;
            position: relative;
            overflow: hidden;
        }
        .status-pill::before {
            content: ''; position: absolute; top:0; left:0; width: 4px; height: 100%;
            background: var(--guide-active); opacity: 0.8;
        }
        .status-pill:active { transform: scale(0.98); }
        
        #p-job { color: var(--guide-active); font-family: monospace; letter-spacing: 0.5px; }
        #p-name { color: #fff; letter-spacing: 0.5px; }
        .divider { width: 1px; height: 12px; background: rgba(255,255,255,0.3); }

        .status-pill.complete {
            border-color: var(--guide-active);
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.2);
        }

        /* ステップインジケーター */
        .step-indicator {
            position: absolute;
            top: 150px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        .step-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .step-dot.active {
            background: #fff;
            transform: scale(1.4);
            box-shadow: 0 0 8px rgba(255,255,255,0.8);
            border-color: #fff;
        }
        .step-dot.done {
            background: var(--guide-active);
            border-color: var(--guide-active);
            box-shadow: 0 0 5px var(--guide-active);
        }
        .step-line {
            width: 24px; height: 2px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .step-line.done { background: var(--guide-active); opacity: 0.8; }

        .scan-hint {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 60%, transparent 100%);
            padding-bottom: 50px;
            padding-top: 60px;
        }

        /* --- SVGマスク --- */
        #svg-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 5;
        }
        .mask-path { fill: var(--mask-color); fill-rule: evenodd; transition: fill 0.3s; }
        .guide-corner {
            fill: none; stroke: var(--guide-color); stroke-width: 4;
            stroke-linecap: round; transition: stroke 0.3s;
            filter: drop-shadow(0px 0px 4px rgba(0,0,0,0.5));
        }
        #svg-overlay.active .guide-corner { stroke: var(--guide-active); }
        #svg-overlay.char-mode .guide-corner { stroke: var(--primary-color); }
        #svg-overlay.complete .guide-corner { stroke: transparent; } 

        /* --- スタート画面 --- */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: opacity 0.5s;
        }
        .title-logo {
            font-size: 3rem;
            font-weight: 900;
            line-height: 1;
            text-align: center;
            letter-spacing: -1px;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #fff 0%, #aaa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255,255,255,0.3);
        }
        .title-sub {
            font-size: 1rem;
            font-weight: 400;
            letter-spacing: 4px;
            color: var(--primary-color);
            margin-top: -30px;
            margin-bottom: 60px;
            text-transform: uppercase;
        }
        .tap-start {
            font-size: 1.2rem;
            font-weight: 700;
            color: #888;
            animation: blink 1.5s infinite;
            letter-spacing: 2px;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* --- ターンチェンジ画面 (共通) --- */
        #turn-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 60;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 0.3s;
        }
        #turn-screen.visible { display: flex; }
        
        .turn-label { font-size: 1rem; color: #888; margin-bottom: 10px; letter-spacing: 2px; }
        .turn-player { 
            font-size: 4rem; font-weight: 900; line-height: 1; margin-bottom: 40px; 
            text-transform: uppercase; font-style: italic;
        }
        .p1-text { color: var(--p1-color); text-shadow: 0 0 20px rgba(10,132,255,0.4); }
        .p2-text { color: var(--p2-color); text-shadow: 0 0 20px rgba(255,69,58,0.4); }

        /* --- VS画面 (比較用) --- */
        #vs-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #111;
            z-index: 200; /* 最前面 */
            display: none;
            flex-direction: column;
            overflow-y: auto;
            padding-bottom: 40px;
        }
        #vs-screen.visible { display: flex; }
        
        .vs-header {
            text-align: center;
            padding: 20px 0;
            font-size: 2.5rem;
            font-weight: 900;
            font-style: italic;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            background: linear-gradient(to bottom, #1a1a1a, #000);
            border-bottom: 1px solid #333;
        }

        .vs-container {
            flex: 1;
            display: flex;
            flex-direction: column; /* スマホなら縦並び */
            padding: 20px;
            gap: 20px;
        }

        .player-card {
            background: #222;
            border-radius: 16px;
            padding: 16px;
            border: 2px solid #444;
            position: relative;
        }
        .player-card.p1 { border-color: var(--p1-color); background: linear-gradient(135deg, rgba(0,122,255,0.1), rgba(0,0,0,0)); }
        .player-card.p2 { border-color: var(--p2-color); background: linear-gradient(135deg, rgba(255,59,48,0.1), rgba(0,0,0,0)); }

        .pc-label {
            position: absolute;
            top: -12px; left: 20px;
            background: #000;
            padding: 2px 12px;
            font-weight: 800;
            font-size: 0.8rem;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .pc-label.p1 { color: var(--p1-color); border-color: var(--p1-color); }
        .pc-label.p2 { color: var(--p2-color); border-color: var(--p2-color); }

        .pc-info { text-align: center; margin-bottom: 15px; margin-top: 10px;}
        .pc-name { font-size: 1.2rem; font-weight: 800; font-family: monospace; }
        .pc-job { font-size: 0.8rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

        .pc-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            text-align: center;
            gap: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px 0;
            margin-bottom: 10px;
        }
        .pc-equip-list { font-size: 0.8rem; }
        .pc-equip-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .pc-equip-item:last-child { border-bottom: none; }
        
        /* --- モーダル (共通) --- */
        .modal {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            background: var(--stat-bg);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            box-sizing: border-box;
            transform: translateY(110%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 50;
            color: #fff;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
            pointer-events: auto;
        }
        .modal.visible { transform: translateY(0); }
        .modal-handle { width: 40px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 3px; margin: 0 auto 24px; }

        /* --- キャラクターステータス --- */
        .char-card {
            background: rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .char-title { font-size: 0.8rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .char-name { font-size: 1.4rem; font-weight: 800; margin-bottom: 4px; }
        .char-job { display: inline-block; font-size: 0.75rem; font-weight: bold; background: #fff; color: #000; padding: 2px 8px; border-radius: 4px; margin-bottom: 16px; }

        .stats-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .stat-col { flex: 1; text-align: center; }
        .stat-label { font-size: 0.7rem; color: #888; font-weight: 700; display: block; }
        .stat-val { font-size: 1.5rem; font-weight: 800; font-family: "Helvetica Neue", sans-serif; }
        
        .val-hp { color: var(--hp-color); }
        .val-st { color: var(--st-color); }
        .val-df { color: var(--df-color); }

        /* 装備リスト */
        .equip-list {
            margin-top: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 10px;
        }
        .equip-slot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
        .equip-slot:last-child { border-bottom: none; }
        .slot-label { font-size: 0.7rem; color: #666; width: 24px; text-align:center; font-weight:bold; }
        .slot-item { flex: 1; color: #fff; font-weight: bold; text-align: left; padding-left: 10px; }
        .slot-empty { color: #444; font-weight: normal; font-style: italic; }
        .slot-stats { font-size: 0.7rem; color: var(--guide-active); }


        /* --- アイテムカード --- */
        .item-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .rarity-stars { font-size: 1.2rem; margin-bottom: 8px; letter-spacing: 2px; }
        .item-type { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 4px; }
        .item-name { font-size: 1.4rem; font-weight: 800; margin-bottom: 16px; line-height: 1.3; }
        
        .item-diff {
            display: flex; justify-content: center; gap: 16px;
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 12px;
        }
        .diff-val { font-size: 1rem; font-weight: bold; }
        .diff-plus { color: var(--st-color); }

        .item-card[data-rarity="1"] { border-color: var(--rarity-1); box-shadow: 0 0 15px rgba(142,142,147,0.1); }
        .item-card[data-rarity="1"] .rarity-stars { color: var(--rarity-1); }
        
        .item-card[data-rarity="2"] { border-color: var(--rarity-2); box-shadow: 0 0 15px rgba(50,215,75,0.2); }
        .item-card[data-rarity="2"] .rarity-stars { color: var(--rarity-2); }

        .item-card[data-rarity="3"] { border-color: var(--rarity-3); box-shadow: 0 0 20px rgba(10,132,255,0.3); }
        .item-card[data-rarity="3"] .rarity-stars { color: var(--rarity-3); }

        .item-card[data-rarity="4"] { border-color: var(--rarity-4); box-shadow: 0 0 25px rgba(191,90,242,0.4); }
        .item-card[data-rarity="4"] .rarity-stars { color: var(--rarity-4); }

        .item-card[data-rarity="5"] { 
            border-color: var(--rarity-5); 
            box-shadow: 0 0 30px rgba(255,214,10,0.5); 
            background: linear-gradient(135deg, rgba(255,214,10,0.2) 0%, rgba(0,0,0,0) 100%);
        }
        .item-card[data-rarity="5"] .rarity-stars { color: var(--rarity-5); text-shadow: 0 0 10px var(--rarity-5); }


        /* ボタン */
        .btn {
            width: 100%;
            padding: 18px;
            border-radius: 16px;
            border: none;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            background: #333;
            color: #fff;
            margin-top: 10px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-color); }
        .btn-equip { background: var(--guide-active); color: #000; }
        .btn-danger { background: #ff3b30; color: #fff; }

        /* Toast */
        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); padding: 16px 32px; border-radius: 30px;
            font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 200; white-space: nowrap; border: 1px solid rgba(255,255,255,0.2);
        }
        #toast.show { opacity: 1; }

        /* --- Battle Screen (Modern UI) --- */
        #battle-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 100; display: none; flex-direction: column;
        }
        #battle-screen.visible { display: flex; }

        .battle-view { flex: 1; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        
        .battler-card { 
            background: rgba(28, 28, 30, 1); border-radius: 16px; padding: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .battler-card.p1 { border-left: 4px solid var(--p1-color); }
        .battler-card.p2 { border-right: 4px solid var(--p2-color); text-align: right; }

        .b-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .p2 .b-header { flex-direction: row-reverse; }
        
        .b-name { font-size: 1.1rem; font-weight: 800; }
        .b-job { font-size: 0.8rem; color: #8e8e93; font-weight: 600; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; }
        
        .b-hp-container { margin-top: 5px; }
        .b-hp-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-bottom: 6px; }
        .b-hp-bar { height: 100%; width: 100%; transition: width 0.5s ease-out; }
        .p1-bar { background: var(--p1-color); } .p2-bar { background: var(--p2-color); }
        .b-hp-text { font-size: 1.4rem; font-weight: 800; font-family: "SF Pro Display", sans-serif; letter-spacing: -0.5px; }

        /* Battle Log */
        .battle-log-area { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 100%; text-align: center; pointer-events: none; z-index: 20;
        }
        .log-text { 
            font-size: 1rem; font-weight: 600; background: rgba(0,0,0,0.8); color: #fff;
            padding: 8px 24px; border-radius: 20px; display: inline-block;
            backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.2s;
        }
        .log-text.show { opacity: 1; }
        
        .dmg-popup { 
            font-size: 3.5rem; font-weight: 900; color: #ff3b30; 
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); 
            opacity: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        @keyframes popDamage { 
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 
            40% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 
            100% { transform: translate(-50%, -80%) scale(1.0); opacity: 0; } 
        }
        
        /* Command Area (4 Buttons) */
        .command-area { 
            background: #1c1c1e; padding: 20px; 
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            border-top: 1px solid rgba(255,255,255,0.1);
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }
        .cmd-btn {
            background: #2c2c2e; border: none; border-radius: 14px;
            padding: 16px; color: #555; font-size: 1rem; font-weight: 700;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s; cursor: not-allowed;
        }
        .cmd-sub { font-size: 0.7rem; font-weight: 500; margin-top: 4px; opacity: 0.7; }
        
        /* Active Buttons */
        .cmd-btn.p1-active { 
            background: var(--p1-color); color: #fff; cursor: pointer;
            box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);
        }
        .cmd-btn.p2-active { 
            background: var(--p2-color); color: #fff; cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
        }
        .cmd-btn:active { transform: scale(0.96); }

        /* Skill List Modal */
        #skill-modal {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
            background: #1c1c1e; border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 200; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            pointer-events: auto;
        }
        #skill-modal.visible { transform: translateY(0); }
        .skill-header { padding: 20px; text-align: center; font-weight: 700; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .skill-list { flex: 1; overflow-y: auto; padding: 10px; }
        .skill-item {
            padding: 16px; border-radius: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; color: #fff; font-weight: 600;
        }
        .skill-item:active { background: rgba(255,255,255,0.1); }
        .skill-pow { color: var(--st-color); font-size: 0.9rem; }

        .shaking { animation: shake 0.4s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }

        /* Result Modal */
        #result-modal { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 500; display: none; flex-direction: column; justify-content: flex-end; }
        #result-modal.visible { display: flex; }

    </style>
</head>
<body>

    <!-- 1. スタート画面 -->
    <div id="start-screen" onclick="initApp()">
        <div class="title-logo">BARCODE<br>BATTLER</div>
        <div class="title-sub">SCAN & FIGHT</div>
        <div class="tap-start">TAP TO START</div>
    </div>

    <div id="scanner-wrapper">
        <div id="reader"></div>
        
        <!-- ターン開始画面 (共通) -->
        <div id="turn-screen">
            <div class="turn-label">CURRENT TURN</div>
            <div class="turn-player" id="turn-player-text">PLAYER 1</div>
            <button class="btn btn-primary" style="width:200px;" onclick="startTurnAction()">READY</button>
        </div>

        <!-- VS画面 (完了画面) -->
        <div id="vs-screen">
            <div class="vs-header">VS</div>
            <div class="vs-container">
                <!-- P1 Card -->
                <div class="player-card p1" id="vs-p1-card">
                    <div class="pc-label p1">PLAYER 1</div>
                    <div class="pc-info">
                        <div class="pc-name" id="vs-p1-name">--</div>
                        <div class="pc-job" id="vs-p1-job">--</div>
                    </div>
                    <div class="pc-stats">
                        <div><span class="stat-label">HP</span><span class="stat-val val-hp" id="vs-p1-hp">0</span></div>
                        <div><span class="stat-label">ST</span><span class="stat-val val-st" id="vs-p1-st">0</span></div>
                        <div><span class="stat-label">DF</span><span class="stat-val val-df" id="vs-p1-df">0</span></div>
                    </div>
                    <div class="pc-equip-list" id="vs-p1-equip"></div>
                </div>

                <!-- P2 Card -->
                <div class="player-card p2" id="vs-p2-card">
                    <div class="pc-label p2">PLAYER 2</div>
                    <div class="pc-info">
                        <div class="pc-name" id="vs-p2-name">--</div>
                        <div class="pc-job" id="vs-p2-job">--</div>
                    </div>
                    <div class="pc-stats">
                        <div><span class="stat-label">HP</span><span class="stat-val val-hp" id="vs-p2-hp">0</span></div>
                        <div><span class="stat-label">ST</span><span class="stat-val val-st" id="vs-p2-st">0</span></div>
                        <div><span class="stat-label">DF</span><span class="stat-val val-df" id="vs-p2-df">0</span></div>
                    </div>
                    <div class="pc-equip-list" id="vs-p2-equip"></div>
                </div>
            </div>
            <div style="padding:20px;">
                <button class="btn btn-danger" onclick="startCombatMode()">START BATTLE</button>
            </div>
        </div>

        <svg id="svg-overlay"><path id="mask-path" class="mask-path" d=""/><path id="guide-path" class="guide-corner" d=""/></svg>
        
        <div id="ui-layer">
            <div class="player-turn-bar">
                <div class="turn-badge p1" id="turn-badge">PLAYER 1 TURN</div>
            </div>

            <!-- 情報バー (HUD風) -->
            <div class="info-bar">
                <div class="status-pill" id="player-status" onclick="showCharModal()">
                    <span id="p-job">No Data</span>
                    <div class="divider"></div>
                    <span id="p-name">Scan Barcode</span>
                </div>
            </div>

            <!-- ステップ表示エリア -->
            <div class="step-indicator">
                <div class="step-dot active" id="dot-1"></div>
                <div class="step-line" id="line-1"></div>
                <div class="step-dot" id="dot-2"></div>
                <div class="step-line" id="line-2"></div>
                <div class="step-dot" id="dot-3"></div>
            </div>

            <div class="scan-hint" id="scan-hint-text">
                まずはバーコード(JAN)をスキャン！
            </div>
        </div>
        
        <div id="toast">Message</div>
    </div>

    <!-- 1. キャラクター詳細モーダル -->
    <div id="char-modal" class="modal">
        <div class="modal-handle"></div>
        <div class="char-card">
            <div class="char-title">Current Character</div>
            <div class="char-name" id="cm-name">--</div>
            <div class="char-job" id="cm-job">--</div>
            
            <div class="stats-row">
                <div class="stat-col">
                    <span class="stat-label">HP</span>
                    <span class="stat-val val-hp" id="cm-hp">0</span>
                </div>
                <div class="stat-col">
                    <span class="stat-label">ST</span>
                    <span class="stat-val val-st" id="cm-st">0</span>
                </div>
                <div class="stat-col">
                    <span class="stat-label">DF</span>
                    <span class="stat-val val-df" id="cm-df">0</span>
                </div>
            </div>

            <!-- 装備スロット (2つまで) -->
            <div class="equip-list">
                <div class="equip-slot">
                    <span class="slot-label">1</span>
                    <span class="slot-item" id="slot-1-name">なし</span>
                    <span class="slot-stats" id="slot-1-stats"></span>
                </div>
                <div class="equip-slot">
                    <span class="slot-label">2</span>
                    <span class="slot-item" id="slot-2-name">なし</span>
                    <span class="slot-stats" id="slot-2-stats"></span>
                </div>
            </div>
        </div>
        
        <button id="btn-close-char" class="btn" onclick="closeModal()">閉じる</button>
    </div>

    <!-- 2. アイテム発見モーダル -->
    <div id="item-modal" class="modal">
        <div class="modal-handle"></div>
        <div class="modal-content" style="background:none; padding:0;">
            <div style="text-align:center; font-weight:bold; color:#ffd60a; margin-bottom:10px;">ITEM DISCOVERED!</div>
            <div class="item-card" id="new-item-card" data-rarity="1">
                <div class="rarity-stars" id="item-stars">★</div>
                <div class="item-type" id="item-type">WEAPON</div>
                <div class="item-name" id="item-name">錆びた剣</div>
                <div class="item-diff">
                    <div class="diff-val"><span style="font-size:0.7rem; color:#888;">ST</span> <span id="item-st">+0</span></div>
                    <div class="diff-val"><span style="font-size:0.7rem; color:#888;">DF</span> <span id="item-df">+0</span></div>
                    <div class="diff-val"><span style="font-size:0.7rem; color:#888;">HP</span> <span id="item-hp">+0</span></div>
                </div>
            </div>
            <button class="btn btn-equip" onclick="equipItem()">装備する</button>
            <button class="btn" style="background:transparent; color:#888; margin-top:0;" onclick="discardItem()">破棄する</button>
        </div>
    </div>

    <!-- 3. バトル画面 (Modern UI) -->
    <div id="battle-screen">
        <div class="battle-view">
            <!-- P2 Top -->
            <div class="battler-card p2" id="box-p2">
                <div class="b-header">
                    <span class="b-name" style="color:var(--p2-color)">PLAYER 2</span>
                    <span class="b-job" id="b-p2-job">WIZARD</span>
                </div>
                <div class="b-hp-container">
                    <div class="b-hp-bar-bg"><div class="b-hp-bar p2-bar" id="b-p2-fill" style="width:100%"></div></div>
                    <div class="b-hp-text" id="b-p2-hp">0</div>
                </div>
            </div>

            <!-- Log -->
            <div class="battle-log-area">
                <div class="log-text" id="battle-log">READY...</div>
                <div class="dmg-popup" id="dmg-popup">0</div>
            </div>

            <!-- P1 Bottom -->
            <div class="battler-card p1" id="box-p1">
                <div class="b-header">
                    <span class="b-name" style="color:var(--p1-color)">PLAYER 1</span>
                    <span class="b-job" id="b-p1-job">WARRIOR</span>
                </div>
                <div class="b-hp-container">
                    <div class="b-hp-bar-bg"><div class="b-hp-bar p1-bar" id="b-p1-fill" style="width:100%"></div></div>
                    <div class="b-hp-text" id="b-p1-hp">0</div>
                </div>
            </div>
        </div>

        <div class="command-area">
            <button id="cmd-p1-battle" class="cmd-btn" onclick="execCmd('p1', 'battle')">
                <span>P1 BATTLE</span>
                <span class="cmd-sub">物理技選択</span>
            </button>
            <button id="cmd-p1-power" class="cmd-btn" onclick="execCmd('p1', 'power')">
                <span>P1 POWER</span>
                <span class="cmd-sub">特殊技選択</span>
            </button>
            <button id="cmd-p2-battle" class="cmd-btn" onclick="execCmd('p2', 'battle')">
                <span>P2 BATTLE</span>
                <span class="cmd-sub">物理技選択</span>
            </button>
            <button id="cmd-p2-power" class="cmd-btn" onclick="execCmd('p2', 'power')">
                <span>P2 POWER</span>
                <span class="cmd-sub">特殊技選択</span>
            </button>
        </div>
    </div>

    <!-- 4. スキル選択モーダル -->
    <div id="skill-modal">
        <div class="skill-header">技を選択</div>
        <div class="skill-list" id="skill-list-container">
            <!-- JS Generated -->
        </div>
        <div style="padding:20px;">
            <button class="btn" style="background:#333;" onclick="closeSkillMenu()">キャンセル</button>
        </div>
    </div>

    <!-- 5. 勝利リザルトモーダル -->
    <div id="result-modal" class="modal">
        <div class="modal-handle"></div>
        <div class="char-card" style="text-align:center;">
            <div class="char-title" style="color:var(--guide-active); font-size:1rem;">BATTLE RESULT</div>
            <div id="winner-text" style="font-size:2.5rem; font-weight:900; margin:10px 0;">WINNER!</div>
            <div id="winner-pname" style="font-size:1.5rem; font-weight:800; margin-bottom:30px;">PLAYER 1</div>
            
            <div style="font-size:0.8rem; color:#8e8e93; margin-bottom:10px;">REMAINING HP</div>
            <div id="winner-hp-val" style="font-size:2rem; font-weight:900; font-family:monospace; color:var(--hp-color);">0</div>
            
            <button class="btn btn-danger" style="margin-top:40px;" onclick="location.reload()">REMATCH (RESET)</button>
        </div>
    </div>

    <script>
        // ==========================================
        //  M2281 GIANT PRIME LOGIC
        // ==========================================
        const M2281_PRIME = 2n ** 2281n - 1n;

        function getSeed(str) {
            let s = 0n;
            const MULTIPLIER = 127n;
            for (let i = 0; i < str.length; i++) {
                s = (s * MULTIPLIER + BigInt(str.charCodeAt(i))) % M2281_PRIME;
            }
            return s;
        }

        function createRNG(seed) {
            return () => {
                seed = (seed * 48271n) % M2281_PRIME;
                return Number(seed % 100000000n) / 100000000;
            };
        }

        // ==========================================
        //  DATA GENERATION (10 Skills)
        // ==========================================
        const SKILL_NAMES_B = ["強打", "三連斬", "捨て身の突き", "重低音破", "影縫い", "旋風脚", "震地撃", "瞬迅閃", "兜割り", "双龍脚"];
        const SKILL_NAMES_P = ["ギガフレア", "ダイヤモンドダスト", "裁きの雷", "大地の怒り", "暗黒の波動", "聖なる祈り", "超振動波", "虚無への誘い", "生命の輝き", "絶対零度"];

        function generateChar(code) {
            const r = createRNG(getSeed(code));
            
            const isWarrior = r() > 0.35;
            const job = isWarrior ? "WARRIOR" : "WIZARD";
            const tribe = ["MECHA", "BIRD", "ANIMAL", "HUMAN", "OCEAN"][Math.floor(r()*5)];

            let hp = 30000 + Math.floor(r()*300)*100;
            let st = 5000 + Math.floor(r()*100)*100;
            let df = 2000 + Math.floor(r()*80)*100;
            // DX (素早さ) 判定用ステータス
            let dx = Math.floor(r() * 100);

            if(isWarrior) { hp += 5000; st += 1000; } else { df += 1000; }

            const skills = [];
            for(let i=0; i<10; i++){
                const isMagic = i >= 5;
                const name = isMagic ? SKILL_NAMES_P[Math.floor(r()*10)] : SKILL_NAMES_B[Math.floor(r()*10)];
                const mult = isMagic ? (0.5 + r()*2.0) : (0.9 + r()*0.5); 
                skills.push({ name, mult: parseFloat(mult.toFixed(2)), type: isMagic ? 'power' : 'battle' });
            }

            return { 
                id: code, tribe, job, 
                baseHp: hp, baseSt: st, baseDf: df, dx,
                hp, maxHp: hp, st, df, 
                items: [], skills, isWarrior 
            };
        }

        function generateItem(code) {
            const r = createRNG(getSeed(code));
            const roll = r();
            let type = roll < 0.4 ? "weapon" : (roll < 0.8 ? "armor" : "accessory");
            let rarity = roll < 0.6 ? 1 : (roll < 0.85 ? 2 : (roll < 0.95 ? 3 : (roll < 0.99 ? 4 : 5)));
            const pList = ["錆びた", "鉄の", "名工の", "魔光の", "神々の"];
            const bList = { weapon: ["剣", "斧", "槍"], armor: ["盾", "鎧", "兜"], accessory: ["指輪", "お守り", "勲章"] };
            const name = pList[rarity-1] + bList[type][Math.floor(r()*3)];
            let s=0, d=0, h=0;
            if(type==="weapon") s = Math.floor(500 + r()*500) * rarity;
            else if(type==="armor") d = Math.floor(500 + r()*500) * rarity;
            else h = Math.floor(1000 + r()*1000) * rarity;
            return { name, type, rarity, st:s, df:d, hp:h };
        }

        // --- APP STATE ---
        let turn = 1, p1Data = null, p2Data = null, isScanning = false, pending = null;
        let bTurn = 1, bActive = false;
        const html5QrCode = new Html5Qrcode("reader");

        const ui = {
            start: document.getElementById('start-screen'),
            turnScreen: document.getElementById('turn-screen'),
            turnPlayerText: document.getElementById('turn-player-text'),
            vsScreen: document.getElementById('vs-screen'),
            overlay: document.getElementById('svg-overlay'),
            mask: document.getElementById('mask-path'),
            guide: document.getElementById('guide-path'),
            turnBadge: document.getElementById('turn-badge'),
            pStatus: document.getElementById('player-status'),
            pJob: document.getElementById('p-job'),
            pName: document.getElementById('p-name'),
            hint: document.getElementById('scan-hint-text'),
            toast: document.getElementById('toast'),
            dot1: document.getElementById('dot-1'), dot2: document.getElementById('dot-2'), dot3: document.getElementById('dot-3'),
            charModal: document.getElementById('char-modal'), cmName: document.getElementById('cm-name'), cmJob: document.getElementById('cm-job'),
            cmHp: document.getElementById('cm-hp'), cmSt: document.getElementById('cm-st'), cmDf: document.getElementById('cm-df'),
            itemModal: document.getElementById('item-modal'), itemCard: document.getElementById('new-item-card'),
            battleScreen: document.getElementById('battle-screen'), bP1Hp: document.getElementById('b-p1-hp'), bP2Hp: document.getElementById('b-p2-hp'),
            bP1Bar: document.getElementById('b-p1-fill'), bP2Bar: document.getElementById('b-p2-fill'), bP1Job: document.getElementById('b-p1-job'), bP2Job: document.getElementById('b-p2-job'),
            logMsg: document.getElementById('battle-log'), dmgPopup: document.getElementById('dmg-popup'),
            btns: {
                p1b: document.getElementById('cmd-p1-battle'), p1p: document.getElementById('cmd-p1-power'),
                p2b: document.getElementById('cmd-p2-battle'), p2p: document.getElementById('cmd-p2-power')
            },
            skillModal: document.getElementById('skill-modal'),
            skillList: document.getElementById('skill-list-container'),
            resultModal: document.getElementById('result-modal')
        };

        function initApp() { ui.start.style.display = 'none'; turn = 1; showTurnScreen(); }
        function showTurnScreen() {
            ui.turnPlayerText.innerText = `PLAYER ${turn}`;
            ui.turnPlayerText.className = `turn-player p${turn}-text`;
            ui.turnScreen.classList.add('visible');
            ui.overlay.classList.remove('active', 'char-mode', 'complete');
        }
        function startTurnAction() {
            ui.turnScreen.classList.remove('visible');
            const w = window.innerWidth;
            html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: Math.floor(w*0.85), height: Math.floor(w*0.5) } }, onScan)
            .then(() => { isScanning = true; resizeOverlay(); updatePrepUI(); });
        }
        function onScan(text, result) {
            if (!isScanning) return;
            const isQR = result.result.format.formatName.includes("QR");
            const player = turn === 1 ? p1Data : p2Data;
            if (!player) { if (isQR) { showToast("⚠ JANバーコードを読み込んでください"); return; } foundChar(text); }
            else { if (!isQR) { showToast("⚠ QRコードを読み込んでください"); return; } foundItem(text); }
        }
        function foundChar(c) {
            isScanning = false; const data = generateChar(c); pending = { type: 'char', data: data };
            ui.cmName.innerText = "CODE: " + c.substring(0,8); ui.cmJob.innerText = data.tribe + " / " + data.job;
            ui.cmHp.innerText = data.hp; ui.cmSt.innerText = data.st; ui.cmDf.innerText = data.df;
            document.getElementById('slot-1-name').innerText = "なし"; document.getElementById('slot-2-name').innerText = "なし";
            ui.charModal.classList.add('visible');
        }
        function foundItem(c) {
            isScanning = false; const data = generateItem(c); pending = { type: 'item', data: data };
            ui.itemCard.dataset.rarity = data.rarity; document.getElementById('item-stars').innerText = "★".repeat(data.rarity);
            document.getElementById('item-type').innerText = data.type.toUpperCase(); document.getElementById('item-name').innerText = data.name;
            document.getElementById('item-st').innerText = "+"+data.st; document.getElementById('item-df').innerText = "+"+data.df; document.getElementById('item-hp').innerText = "+"+data.hp;
            ui.itemModal.classList.add('visible');
        }
        function equipItem() {
            const player = turn === 1 ? p1Data : p2Data; if(!player || !pending || !pending.data) return;
            player.items.push(pending.data); recalcStats(player); updatePlayerUI();
            if (player.items.length >= 2) {
                html5QrCode.stop().then(() => { if (turn === 1) { turn = 2; setTimeout(showTurnScreen, 500); } else showVsScreen(); });
                ui.itemModal.classList.remove('visible');
            } else { discardItem(); }
        }
        function closeModal() {
            ui.charModal.classList.remove('visible');
            if(pending && pending.type === 'char') { if(turn === 1) p1Data = pending.data; else p2Data = pending.data; }
            isScanning = true; updatePrepUI(); updatePlayerUI();
        }
        function discardItem() { ui.itemModal.classList.remove('visible'); pending = null; isScanning = true; updatePrepUI(); }
        function recalcStats(p) { p.hp = p.baseHp; p.st = p.baseSt; p.df = p.baseDf; p.items.forEach(i => { p.hp += i.hp; p.st += i.st; p.df += i.df; }); p.maxHp = p.hp; }
        function updatePlayerUI() { const p = turn === 1 ? p1Data : p2Data; if (!p) return; ui.pJob.innerText = p.job; ui.pName.innerText = "CODE: " + p.id.substring(0, 6); }
        function showCharModal() {
            const player = turn === 1 ? p1Data : p2Data; if(!player) return;
            ui.cmName.innerText = "CODE: " + player.id.substring(0,8); ui.cmJob.innerText = player.tribe + " / " + player.job;
            ui.cmHp.innerText = player.hp; ui.cmSt.innerText = player.st; ui.cmDf.innerText = player.df;
            document.getElementById('slot-1-name').innerText = player.items[0] ? player.items[0].name : "なし";
            document.getElementById('slot-2-name').innerText = player.items[1] ? player.items[1].name : "なし";
            isScanning = false; ui.charModal.classList.add('visible');
        }
        function showVsScreen() {
            document.getElementById('vs-p1-name').innerText = "CODE: " + p1Data.id.substring(0,6);
            document.getElementById('vs-p1-job').innerText = p1Data.tribe + " / " + p1Data.job;
            document.getElementById('vs-p1-hp').innerText = p1Data.hp; document.getElementById('vs-p1-st').innerText = p1Data.st; document.getElementById('vs-p1-df').innerText = p1Data.df;
            document.getElementById('vs-p1-equip').innerHTML = p1Data.items.map(i => `<div class="pc-equip-item"><span>${i.name}</span><span>★${i.rarity}</span></div>`).join('');
            document.getElementById('vs-p2-name').innerText = "CODE: " + p2Data.id.substring(0,6);
            document.getElementById('vs-p2-job').innerText = p2Data.tribe + " / " + p2Data.job;
            document.getElementById('vs-p2-hp').innerText = p2Data.hp; document.getElementById('vs-p2-st').innerText = p2Data.st; document.getElementById('vs-p2-df').innerText = p2Data.df;
            document.getElementById('vs-p2-equip').innerHTML = p2Data.items.map(i => `<div class="pc-equip-item"><span>${i.name}</span><span>★${i.rarity}</span></div>`).join('');
            ui.vsScreen.classList.add('visible');
        }

        function startCombatMode() {
            ui.vsScreen.classList.remove('visible'); ui.battleScreen.classList.add('visible');
            p1Data.curHp = p1Data.hp; p2Data.curHp = p2Data.hp;
            
            // --- 先攻後攻判定 ---
            if (p1Data.dx > p2Data.dx) bTurn = 1;
            else if (p2Data.dx > p1Data.dx) bTurn = 2;
            else bTurn = Math.random() < 0.5 ? 1 : 2;
            
            updateBattleUI(); log(`BATTLE START! 先攻: P${bTurn}`); updateCommandUI();
        }

        function updateBattleUI() {
            ui.bP1Hp.innerText = Math.floor(p1Data.curHp); ui.bP2Hp.innerText = Math.floor(p2Data.curHp);
            ui.bP1Bar.style.width = (p1Data.curHp / p1Data.maxHp * 100) + "%";
            ui.bP2Bar.style.width = (p2Data.curHp / p2Data.maxHp * 100) + "%";
            ui.bP1Job.innerText = p1Data.tribe + " " + p1Data.job;
            ui.bP2Job.innerText = p2Data.tribe + " " + p2Data.job;
        }

        function updateCommandUI() {
            ['cmd-p1-battle','cmd-p1-power','cmd-p2-battle','cmd-p2-power'].forEach(id => document.getElementById(id).className='cmd-btn');
            if (bActive) return;
            if (bTurn === 1) { document.getElementById('cmd-p1-battle').classList.add("p1-active"); document.getElementById('cmd-p1-power').classList.add("p1-active"); }
            else { document.getElementById('cmd-p2-battle').classList.add("p2-active"); document.getElementById('cmd-p2-power').classList.add("p2-active"); }
        }

        function execCmd(p, type) { if ((p === 'p1' && bTurn !== 1) || (p === 'p2' && bTurn !== 2) || bActive) return; openSkillMenu(p, type); }
        function openSkillMenu(p, type) {
            if((p==='p1' && bTurn!==1) || (p==='p2' && bTurn!==2) || bActive) return;
            const data = bTurn === 1 ? p1Data : p2Data;
            ui.skillList.innerHTML = "";
            const targets = type === 'battle' ? data.skills.slice(0, 5) : data.skills.slice(5, 10);
            targets.forEach(s => {
                const div = document.createElement('div'); div.className = 'skill-item';
                div.innerHTML = `<span>${s.name}</span><span class="skill-pow">x${s.mult}</span>`;
                div.onclick = () => { closeSkillMenu(); executeAction(s); };
                ui.skillList.appendChild(div);
            });
            ui.skillModal.classList.add('visible');
        }
        function closeSkillMenu() { ui.skillModal.classList.remove('visible'); }

        function executeAction(skill) {
            if(bActive) return; bActive = true; updateCommandUI();
            const atk = bTurn === 1 ? p1Data : p2Data; const def = bTurn === 1 ? p2Data : p1Data;
            const defBox = bTurn === 1 ? document.getElementById('box-p2') : document.getElementById('box-p1');
            log(`${skill.name} !!`);
            setTimeout(() => {
                // --- 詳細ダメージ計算 ---
                let dmg = (atk.st * skill.mult) - (def.df * 0.4);
                // 種族相性 (Mecha > Bird > Animal > Human > Ocean > Mecha)
                const advantage = { 'MECHA': 'BIRD', 'BIRD': 'ANIMAL', 'ANIMAL': 'HUMAN', 'HUMAN': 'OCEAN', 'OCEAN': 'MECHA' };
                if (advantage[atk.tribe] === def.tribe) dmg *= 1.2;
                // 最低保証
                if (dmg < atk.st * 0.1) dmg = atk.st * 0.1;
                // 乱数分散
                dmg = Math.floor(dmg * (0.9 + Math.random() * 0.2));
                // クリティカル
                let isCrit = Math.random() < 0.1;
                if (isCrit) dmg = Math.floor(dmg * 1.5);

                def.curHp -= dmg; if (def.curHp < 0) def.curHp = 0;
                defBox.classList.add('shaking'); setTimeout(() => defBox.classList.remove('shaking'), 400);
                showDmg(isCrit ? "CRIT!" : dmg, isCrit ? "#ffd60a" : "#ff3b30");
                updateBattleUI();

                if (def.curHp <= 0) {
                    log(`PLAYER ${bTurn} WIN!!`);
                    setTimeout(() => {
                        const winnerData = bTurn === 1 ? p1Data : p2Data;
                        document.getElementById('winner-pname').innerText = `PLAYER ${bTurn}`;
                        document.getElementById('winner-pname').style.color = bTurn === 1 ? 'var(--p1-color)' : 'var(--p2-color)';
                        document.getElementById('winner-hp-val').innerText = Math.floor(winnerData.curHp);
                        ui.resultModal.classList.add('visible');
                    }, 1500);
                } else {
                    setTimeout(() => { bTurn = bTurn === 1 ? 2 : 1; bActive = false; log(`PLAYER ${bTurn} TURN`); updateCommandUI(); }, 1200);
                }
            }, 600);
        }

        function log(m) { ui.logMsg.innerText = m; ui.logMsg.classList.remove('show'); void ui.logMsg.offsetWidth; ui.logMsg.classList.add('show'); }
        function showDmg(v, c="#ff3b30") { ui.dmgPopup.innerText = v; ui.dmgPopup.style.color = c; ui.dmgPopup.style.animation = 'none'; void ui.dmgPopup.offsetWidth; ui.dmgPopup.style.animation = 'popDamage 0.6s forwards'; }
        function showToast(m) { ui.toast.innerText = m; ui.toast.classList.add('show'); setTimeout(() => ui.toast.classList.remove('show'), 2000); }
        function updatePrepUI() { const p = turn === 1 ? p1Data : p2Data; const step = p ? p.items.length + 1 : 0; ui.turnBadge.innerText = `PLAYER ${turn} TURN`; ui.turnBadge.className = `turn-badge p${turn}`; ui.dot1.className = step >= 1 ? 'step-dot done' : (step === 0 ? 'step-dot active' : 'step-dot'); ui.dot2.className = step >= 2 ? 'step-dot done' : (step === 1 ? 'step-dot active' : 'step-dot'); ui.dot3.className = step >= 3 ? 'step-dot done' : (step === 2 ? 'step-dot active' : 'step-dot'); ui.hint.innerText = step === 0 ? "バーコード(JAN)をスキャン！" : "QRコードで装備を探索！"; }
        
        function resizeOverlay() {
            const w = window.innerWidth, h = window.innerHeight, bw = Math.min(800, w * 0.85), bh = Math.min(bw, h * 0.6), x = (w - bw) / 2, y = (h - bh) / 2;
            const mask = document.getElementById('mask-path');
            const guide = document.getElementById('guide-path');
            if (!mask || !guide) return;
            mask.setAttribute('d', `M 0 0 H ${w} V ${h} H 0 Z M ${x+24} ${y} H ${x+bw-24} Q ${x+bw} ${y} ${x+bw} ${y+24} V ${y+bh-24} Q ${x+bw} ${y+bh} ${x+bw-24} ${y+bh} H ${x+24} Q ${x} ${y+bh} ${x} ${y+bh-24} V ${y+24} Q ${x} ${y} ${x+24} ${y} Z`);
            guide.setAttribute('d', `M ${x} ${y+40} V ${y+24} Q ${x} ${y} ${x+24} ${y} H ${x+40} M ${x+bw-40} ${y} H ${x+bw-24} Q ${x+bw} ${y} ${x+bw} ${y+24} V ${y+40} M ${x+bw} ${y+bh-40} V ${y+bh-24} Q ${x+bw} ${y+bh} ${x+bw-24} ${y+bh} H ${x+bw-40} M ${x+40} ${y+bh} H ${x+24} Q ${x} ${y+bh} ${x} ${y+bh-24} V ${y+bh-40}`);
        }
        window.addEventListener('resize', resizeOverlay);
    </script>
</body>
</html>
